<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON to Tabulator</title>
    <link href="https://unpkg.com/tabulator-tables@6.2.1/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@6.2.1/dist/js/tabulator.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/@rdkit/rdkit/Code/MinimalLib/dist/RDKit_minimal.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #fileInput, #downloadButton, #controlsContainer {
            margin-bottom: 20px;
        }
        #table-container {
            margin-top: 20px;
        }
        .column-toggle {
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <input type="file" id="fileInput" accept=".json">
    <button id="downloadButtonCSV" style="display: none;">Download CSV</button>
    <button id="downloadButtonPDF" style="display: none;">Download PDF</button>
    
    <div id="table-container"></div>

    <script>
        let table;
        let columns;

        async function addMols(array) {
            const RDKitModule = await initRDKitModule();
            mdetails = {}
            mdetails['bondLineWidth'] = 0.9
            return array.map(item => ({
                ...item,
                //['molsvg']: RDKitModule.get_mol(item.SMILES).get_svg(175,150)
                ['molsvg']: RDKitModule.get_mol(
                    item.SMILES
                ).get_svg_with_highlights(
                    JSON.stringify(mdetails)
                )
            }))
        }

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                let jsonData = JSON.parse(e.target.result);
                // add rdkit mols here. 
                addMols(jsonData).then(result => {
                    //console.log('added mols')
                    createTable(result);
                });
                console.log(jsonData)
                document.getElementById('downloadButtonCSV').style.display = 'block';
                document.getElementById('downloadButtonPDF').style.display = 'block';
            };

            reader.readAsText(file);
        });



        document.getElementById("downloadButtonCSV").addEventListener("click", function(){
            table.download("csv", "data.csv");
        });
        document.getElementById("downloadButtonPDF").addEventListener("click", function(){
            table.download("pdf", "data.pdf");
        });
        // document.getElementById('downloadButton').addEventListener('click', function() {
        //     const data = table.getData();
        //     const jsonString = JSON.stringify(data, null, 2);
        //     const blob = new Blob([jsonString], { type: 'application/json' });
        //     const url = URL.createObjectURL(blob);
            
        //     const a = document.createElement('a');
        //     a.href = url;
        //     a.download = 'table_data.json';
        //     document.body.appendChild(a);
        //     a.click();
        //     document.body.removeChild(a);
        //     URL.revokeObjectURL(url);
        // });

        function createTable(data) {
            if (!Array.isArray(data) || data.length === 0) {
               console.error('Invalid JSON data');
               return;
            }
            function svgFormatter(cell, formatterParams, onRendered) {
                // Assuming the cell value is the SVG string
                const svgString = cell.getValue();
                return `<div style="width: 100%; height: 100%;">${svgString}</div>`;
            }

            columns = Object.keys(data[0]).map(key => ({
                title: key.charAt(0).toUpperCase() + key.slice(1),
                field: key,
                editor: "input",
                editable: false,  
               cellDblClick:function(e, cell){
                cell.edit(true);
                },
                //...(key === "molsvg" ? { formatter: "image" } : {})
                ...(key === "molsvg" ? {
                    formatter: svgFormatter,
                    //width: 175, // Adjust as needed
                    //height: 150 // Adjust as needed
                } : {})
            }));
            console.log('columns next up:');
            console.log(columns);

            table = new Tabulator("#table-container", {
                data: data,
                columns: columns,
                //layout: "fitColumns",
                layout: "fitData",
                pagination: "local",
                paginationSize: 10,
                paginationSizeSelector: [5, 10, 20, 50],
                movableColumns: true,
                resizableRows: true
            });

        }

        // function createColumnToggles() {
        //     const container = document.getElementById('controlsContainer');
        //     container.innerHTML = ''; // Clear existing controls
        //     container.style.display = 'block';

        //     columns.forEach(column => {
        //         const toggle = document.createElement('button');
        //         toggle.textContent = `${column.title}: Editable`;
        //         toggle.className = 'column-toggle';
        //         toggle.addEventListener('click', () => toggleColumnEdit(column, toggle));
        //         container.appendChild(toggle);
        //     });
        // }


    </script>
</body>
</html>
